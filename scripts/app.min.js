$(document).ready(function(){$("#StudentCount").keypress(function(e){"13"==e.keyCode&&e.preventDefault()})});var app=angular.module("IC",["firebase","ngAnimate","ngRoute","angular-loading-bar","hue"]),config={apiKey:"AIzaSyBpdRvCW0oJH5ukKNWBZp3jipGVg8w0wyE",authDomain:"interactiveclassroom.firebaseapp.com",databaseURL:"https://interactiveclassroom.firebaseio.com",storageBucket:"project-3354574417935505015.appspot.com"};firebase.initializeApp(config),app.factory("fbRef",[function(){var e=firebase.database().ref();return e}]),app.factory("Auth",["$firebaseAuth",function(e){return e()}]),app.directive("myEnter",function(){return function(e,t,n){t.bind("keydown keypress",function(t){13===t.which&&(e.$apply(function(){e.$eval(n.myEnter)}),t.preventDefault())})}}),angular.module("IC").run(["$rootScope","$location",function(e,t){e.$on("$routeChangeError",function(e,n,r,s){"AUTH_REQUIRED"===s&&t.path("/")})}]),angular.module("IC").config(["$routeProvider",function(e){e.when("/class:classid",{controller:"Student",templateUrl:"student.html",resolve:{currentAuth:["Auth",function(e){return e.$requireSignIn()}]}}).when("/dashboard:classid",{controller:"Teacher",templateUrl:"teacher.html",resolve:{currentAuth:["Auth",function(e){return e.$requireSignIn()}]}}).when("/",{templateUrl:"home.html",controller:"Home"}).when("/:action",{templateUrl:"home.html",controller:"Home"}).otherwise({redirectTo:"/"})}]),angular.module("IC").controller("Home",["$scope","$firebaseObject","$firebaseArray","$timeout","$location","$rootScope","$routeParams","cfpLoadingBar","fbRef",function(e,t,n,r,s,u,o,i,a){var c=a;if(void 0!=o.action){var l=o.action.substring(1);switch(l){case"logout":u.$broadcast("logout")}}e.btngrpclass="",e.invitecode="",e.labeltext="",e.addingClass=!1,e.joinBtn=!1,e.cancel=function(){e.btngrpclass="",e.invitecode="",e.addingClass=!1,e.joinBtn=!1},e.userData={},i.start(),e.$on("userGuid",function(n,s){void 0==s||null==s?(e.userData={},e.cancel(),i.complete()):(e.userData=t(c.child("Users").child(s).child("User")),e.userData.$loaded(function(){e.joinBtn?(e.btngrpclass="homebtngrp--loggedin",e.invitecode="Welcome "+e.userData.name.split(" ")[0]+"!",r(function(){e.invitecode="",e.labeltext=e.labelText(),e.btngrpclass="homebtngrp--invitecode",setTimeout(function(){$(".homebtngrp-left-input").focus()},500)},2e3)):e.cancel(),i.complete()}))}),u.$broadcast("userGuidReq"),e.classroom=function(t){e.addingClass=t,void 0==e.userData.uid?(e.btngrpclass="homebtngrp--login",e.joinBtn=!0,u.$broadcast("login")):(e.labeltext=e.labelText(),e.btngrpclass="homebtngrp--invitecode",setTimeout(function(){$(".homebtngrp-left-input").focus()},500))},e.labelText=function(){return e.addingClass?"Name your new class.":"Please enter your invite code."},e.secondary=function(){switch(e.btngrpclass){case"homebtngrp--login":u.$broadcast("login");break;case"homebtngrp--loggedin":break;case"homebtngrp--invitecode":e.addingClass?e.createClass():e.joinClass();break;default:e.classroom(!0)}},e.createClass=function(){var t=n(c.child("Classes"));t.$add({Pub:{CurrentLesson:null,CurrentTopic:null,Name:e.invitecode,Teacher:e.userData.uid},Lessons:null}).then(function(t){void 0==e.userData.Teaches[t.key()]&&null!=e.userData.Teaches[t.key()]&&(e.userData.Teaches[t.key()]=Date(),e.userData.$save()),s.path("/dashboard:"+t.key())})},e.joinClass=function(){if(""!=e.invitecode&&e.invitecode.length>3){var n=t(c.child("Joiners").child(e.invitecode));n.$loaded(function(){null!=n&&void 0!=n&&(void 0==e.userData.Partakes&&(e.userData.Partakes={}),void 0==e.userData.Partakes[n.Class]&&(e.userData.Partakes[n.Class]=Date(),e.userData.$save()),void 0!=e.userData.Teaches&&void 0!=e.userData.Teaches[n.Class]?s.path("/dashboard:"+n.Class):s.path("/class:"+n.Class))})}}}]),angular.module("IC").controller("Student",["$scope","$firebaseObject","$firebaseArray","$routeParams","$interval","$rootScope","cfpLoadingBar","fbRef",function(e,t,n,r,s,u,o,i){var a=i;e.classid=r.classid.substring(1),e.classInfo=t(a.child("Classes").child(e.classid).child("/Pub")),e.currentAnswer={};var c={};o.start(),e.$on("userGuid",function(n,r){void 0==r||null==r?e.userData={}:e.classInfo.$loaded(function(){var n=a.child("Classes").child(e.classid).child("Lessons").child(e.classInfo.CurrentLesson);e.userData=t(a.child("Users").child(r).child("User")),e.userData.$loaded(function(){e.myHeartbeat=t(n.child("Students").child(e.userData.uid)),e.myHeartbeat.$value=Date(),e.myHeartbeat.$save(),c=s(function(){e.myHeartbeat.$value=Date(),e.myHeartbeat.$save()},3e4),e.currentAnswer=t(n.child("Topics").child(e.classInfo.CurrentTopic).child("Answers").child(e.userData.uid)),o.complete()})})}),u.$broadcast("userGuidReq"),e.$on("$destroy",function(){s.cancel(c)}),e.answer=function(t){e.currentAnswer.Answer=t,e.currentAnswer.Date=Date(),e.currentAnswer.$save()}}]),angular.module("IC").controller("Teacher",["$scope","$firebaseObject","$firebaseArray","$routeParams","$rootScope","hue","fbRef",function(e,t,n,r,s,u,o){var i=o;e.classid=r.classid.substring(1);var a=i.child("Classes").child(e.classid),c=u;c.setup({username:"SzDOKancs7zL7Vubik2dn3MAqJJ8QU46iRZa7qpB",bridgeIP:"172.16.11.40",debug:!0}),c.getLights().then(function(t){e.lights=t,console.log(t),c.setLightState(1,{on:!0}).then(function(e){console.log("API response: ",e)})}),e.convertRGBtoXY=function(e,t,n){e=e>.04045?Math.pow((e+.055)/1.055,2.4):e/12.92,t=t>.04045?Math.pow((t+.055)/1.055,2.4):t/12.92,n=n>.04045?Math.pow((n+.055)/1.055,2.4):n/12.92;var r=.664511*e+.154324*t+.162028*n,s=.283881*e+.668433*t+.047685*n,u=88e-6*e+.07231*t+.986039*n,o=r/(r+s+u),i=s/(r+s+u);return isNaN(o)&&(o=0),isNaN(i)&&(i=0),[o,i]},e.testthethings=function(){c.getLights().then(function(t){e.lights=t,console.log(t);var n=e.datinput.split(","),r=e.convertRGBtoXY(n[0],n[1],n[2]);c.setLightState(1,{on:!0,xy:r,transitiontime:0}).then(function(e){console.log("API response: ",e)})})},s.$broadcast("userGuidReq"),e.$on("userGuid",function(n,r){void 0==r||null==r?e.userData={}:(e.userData=t(i.child("Users").child(r).child("User")),e.classPub=t(a.child("/Pub")))}),e.$watch("classPub",function(n,r){void 0!=n&&void 0!=n.CurrentLesson?((void 0==r||n.CurrentLesson!=r.CurrentLesson)&&(e.Lesson=t(a.child("Lessons").child(n.CurrentLesson)),e.Students=t(a.child("Students"))),(void 0==r||n.CurrentTopic!=r.CurrentTopic&&void 0!=n.CurrentTopic)&&(e.Topic=t(a.child("Lessons").child(n.CurrentLesson).child("Topics").child(n.CurrentTopic)),console.log(e.Topic),e.Topic.$loaded(function(){console.log(e.Topic)}))):(e.Students={},e.Lesson={},e.Topic={})}),e.$watch("Topic.Answers",function(t,n){void 0!=t?(e.Answers.Total=0,e.Answers.zero=0,e.Answers.one=0,e.Answers.two=0,angular.forEach(t,function(t){e.Answers.Total+=1,t.Answer<1?e.Answers.zero+=1:t.Answer<2?e.Answers.one+=1:t.Answer<3&&(e.Answers.two+=1)}),console.log(e.Answers)):e.Answers={}}),e.$watch("Students",function(e,t){if(void 0!=e){var n=0;angular.forEach(e,function(e){n+=1})}}),e.pluralsAreGoodIGuess=function(e){return e>1?"s":void 0},e.$watch("lampSel",function(t){angular.forEach(e.Lamps,function(n,r){t==n&&(e.Settings.Lamp=r,e.Settings.$save())})}),e.createNewLesson=function(){var t=new Firebase(e.fbRefClass+"/Lessons"),n=({Date:Date(),Students:null},t.push(les)),r=new Firebase(n.toString()+"/Sessions"),s={Date:Date(),StudentCount:e.stuCount,TrueCount:0,FalseCount:0},u=r.push(s);e.Settings.CurrentLesson=n.key(),e.Settings.CurrentSession=u.key(),e.Settings.$save()},e.createNewSession=function(){var t=new Firebase(e.fbRefClass+"/Lessons/"+e.Settings.CurrentLesson+"/Sessions"),n={Date:Date(),StudentCount:e.stuCount,TrueCount:0,FalseCount:0},r=t.push(n);e.Settings.CurrentSession=r.key(),e.Settings.$save()},e.finishLesson=function(){e.Settings.CurrentSession="",e.Settings.CurrentLesson="",e.Settings.$save(),e.CurrentSession={}},e.editc=!1,e.colors=new Array,e.avalicolors=["Violet","RoyalBlue","LightSkyBlue","Aqua","AquaMarine","Green","LimeGreen","Yellow","Goldenrod","Orange","Red","Pink","Fuchsia","Orchid","Lavender"],e.colors.push({perc:"0%"}),e.colors.push({color:"Violet",perc:"40%"}),e.colors.push({color:"RoyalBlue",perc:"50%"}),e.colors.push({color:"LightSkyBlue",perc:"70%"}),e.colors.push({color:"AquaMarine",perc:"100%"}),e.colorPercDiff=function(t){var n=e.colors.indexOf(t)-1,r=parseInt(e.colors[n].perc.substring(0,t.perc.length-1)),s=parseInt(t.perc.substring(0,t.perc.length-1));return s-r+"%"},e.findColor=function(t){var n="bgc-gray",r=0;return angular.forEach(e.colors,function(e){var s=parseInt(e.perc.substring(0,e.perc.length-1));t>=r&&s>t&&(n="bglc-"+e.color),r=s}),n}}]),angular.module("IC").controller("Nav",["$scope","$firebaseObject","$firebaseArray","Auth","$timeout","$location","$rootScope","fbRef",function(e,t,n,r,s,u,o,i){var a=i;o.userData={},r.$onAuthStateChanged(function(e){null!=e?(o.userData=t(a.child("Users").child(e.uid).child("User")),o.userData.$loaded(function(){o.userData.uid=e.uid,o.userData.email=e.providerData[0].email,o.userData.name=e.providerData[0].displayName,o.userData.profileImageURL=e.providerData[0].photoURL,o.userData.LastLogin=Date(),o.userData.$save().then(function(){o.$broadcast("userGuid",o.userData.uid)})}),o.classData=t(a.child("Users").child(e.uid).child("Classes"))):(o.userData={},o.$broadcast("userGuid",void 0))}),e.$on("userGuidReq",function(e){o.$broadcast("userGuid",o.userData.uid)}),e.$watch("userData.uid",function(e,t){void 0==e&&r.$getAuth(),console.log("watchauth: "+e)}),e.$on("login",function(){var e=new firebase.auth.GoogleAuthProvider;e.addScope("email"),e.addScope("profile"),r.$signInWithPopup(e).then(function(e){})["catch"](function(t){"TRANSPORT_UNAVAILABLE"===t.code?r.$signInWithRedirect(e).then(function(e){}):o.$broadcast("userGuidHome",null)})}),e.$on("logout",function(){r.$signOut(),o.userData={},u.path("/")}),e.nav=!1,e.showNav=function(){return void 0==o.userData.uid?!1:!0},e.navitemsdef=new Array({icon:"replay",link:"#/",fb:{Name:"Home"}},{icon:"highlight_off",link:"#/:logout",fb:{Name:"Log off"}}),e.navitems=new Array,e.navitemspartakes=new Array,e.navitemsteaches=new Array,e.itemsUpdate=function(){var t=[e.navitemspartakes,e.navitemsteaches,e.navitemsdef];e.navitems=[],angular.forEach(t,function(t){angular.forEach(t,function(t){e.navitems.push(t)})}),e.nav&&(e.items=e.navitems)},e.$watch("classData.Partakes",function(n,r){e.navitemspartakes=new Array,void 0!=n&&null!=n?angular.forEach(n,function(n,r){var s=t(a.child("Classes").child(r).child("Pub"));s.$loaded(function(){var t=!1;""!=s.CurrentLesson&&(t=!0),e.navitemspartakes.push({icon:"face",link:"#/class:"+r,active:t,fb:s}),e.itemsUpdate()})}):e.itemsUpdate()}),e.$watch("classData.Teaches",function(n,r){e.navitemsteaches=new Array,void 0!=n&&null!=n?angular.forEach(n,function(n,r){var s=t(a.child("Classes").child(r).child("Pub"));s.$loaded(function(){var t=!1;""!=s.CurrentLesson&&(t=!0),e.navitemsteaches.push({icon:"stars",link:"#/dashboard:"+r,active:t,fb:s}),e.itemsUpdate()})}):e.itemsUpdate()}),e.toggle=function(){e.items=new Array,e.nav||(e.items=e.navitems),e.nav=!e.nav}}]),angular.module("hue",[]).service("hue",["$http","$q","$log",function(e,t,n){var r,s,u,o,i,a,c,l,h,d,f,p;s={username:"",apiUrl:"",bridgeIP:""},o=!1,p=function(){var e;return e=t.defer(),o?(e.resolve(),e.promise):""===s.username?(n.error("Error in setup: Username has to be set"),e.reject,e.promise):""!==s.apiUrl?(o=!0,e.resolve(),e.promise):(""!==s.bridgeIP?(s.apiUrl=r(),o=!0,e.resolve()):u().then(function(t){return null!=t[0]?(s.bridgeIP=t[0].internalipaddress,s.apiUrl=r(),o=!0,e.resolve()):(n.error("Error in setup: Returned data from nupnp is empty. Is there a hue bridge present in this network?"),e.reject)},function(t){return n.error("Error in setup: "+t),e.reject}),e.promise)},d=function(r,s,u){var o;return o=t.defer(),e.put(s,u).success(function(e){return f(r,e,o)}).error(function(e){return n.error("Error: "+r,e),o.reject}),o.promise},h=function(r,s,u){var o;return o=t.defer(),e.post(s,u).success(function(e){return f(r,e,o)}).error(function(e){return n.error("Error: "+r,e),o.reject}),o.promise},c=function(r,s){var u;return u=t.defer(),e["delete"](s).success(function(e){return f(r,e,u)}).error(function(e){return n.error("Error: "+r,e),u.reject}),u.promise},l=function(r,s){var u;return u=t.defer(),e.get(s).success(function(e){return f(r,e,u)}).error(function(e){return n.error(""+r,e),u.reject}),u.promise},f=function(e,t,r){return null!=t[0]&&t[0].error?(n.error(""+e,t),r.reject):(n.debug("Response of "+e+":",t),r.resolve(t))},a=function(e){var t,n,r,u;for(null==e&&(e=[]),n=s.apiUrl,r=0,u=e.length;u>r;r++)t=e[r],n+="/"+t;return n},i=function(e,t,r){var s,u;switch(null==t&&(t=[]),null==r&&(r=null),s=e+t.join("/"),u=a(t),e){case"get":return l(s,u);case"post":return h(s,u,r);case"put":return d(s,u,r);case"delete":return c(s,u);default:return n.error("unsupported method "+e)}},u=function(){return l("getBridgeNupnp","https://www.meethue.com/api/nupnp")},r=function(){return"http://"+s.bridgeIP+"/api/"+s.username},this.getBridgeIP=function(){return p().then(function(){return s.bridgeIP})},this.setup=function(e){return null==e&&(e={}),angular.extend(s,e)},this.getLights=function(){return p().then(function(){return i("get",["lights"])})},this.getNewLights=function(){return p().then(function(){return i("get",["lights","new"])})},this.searchNewLights=function(){return p().then(function(){return i("post",["lights"],{})})},this.getLight=function(e){return p().then(function(){return i("get",["lights",e])})},this.setLightName=function(e,t){return p().then(function(){return i("put",["lights",e],{name:t})})},this.setLightState=function(e,t){return p().then(function(){return i("put",["lights",e,"state"],t)})},this.getConfiguration=function(){return p().then(function(){return i("get",["config"])})},this.setConfiguration=function(e){return p().then(function(){return i("put",["config"],e)})},this.createUser=function(e,t){return null==t&&(t=!1),p().then(function(){var n;return n={devicetype:e},t&&(n.username=t),i("post",["api"],n)})},this.deleteUser=function(e){return p().then(function(){return i("delete",["config","whitelist",e])})},this.getFullState=function(){return p().then(function(){return i("get")})},this.getGroups=function(){return p().then(function(){return i("get",["groups"])})},this.createGroup=function(e,t){return p().then(function(){var r;return r={lights:t,name:e},n.debug("Debug: createGroup body",r),i("post",["groups"],r)})},this.getGroupAttributes=function(e){return p().then(function(){return i("get",["groups",e])})},this.setGroupAttributes=function(e,t,n){return p().then(function(){var r;return r={lights:n,name:t},i("put",["groups",e],r)})},this.setGroupState=function(e,t){return p().then(function(){return i("put",["groups",e,"action"],t)})},this.deleteGroup=function(e){return p().then(function(){return i("delete",["groups",e])})},this.getRules=function(){return p().then(function(){return i("get",["rules"])})},this.getRule=function(e){return p().then(function(){return i("get",["rules",e])})},this.createRule=function(e,t,n){return p().then(function(){var r;return r={name:e,conditions:t,actions:n},i("post",["rules"],r)})},this.updateRule=function(e,t,r,s){return null==t&&(t=!1),null==r&&(r=!1),null==s&&(s=!1),p().then(function(){var e;return e={},t&&(e.name=t),r&&(e.conditions=r),s&&(e.actions=s),n.debug("Debug: updateRule body",e),i("put",["rules"],e)})},this.deleteRule=function(e){return p().then(function(){return i("delete",["rules",e])})},this.getSchedules=function(){return p().then(function(){return i("get",["schedules"])})},this.createSchedule=function(e,t,n,r,s,u){return null==e&&(e="schedule"),null==t&&(t=""),null==s&&(s="enabled"),null==u&&(u=!1),p().then(function(){var o;return o={name:e,description:t,command:n,time:r,status:s,autodelete:u},i("post",["schedules"],o)})},this.getScheduleAttributes=function(e){return p().then(function(){return i("get",["schedules",e])})},this.setScheduleAttributes=function(e,t,n,r,s,u,o){return null==t&&(t=null),null==n&&(n=null),null==r&&(r=null),null==s&&(s=null),null==u&&(u=null),null==o&&(o=null),p().then(function(){var s;return s={},t&&(s.name=t),n&&(s.description=n),r&&(s.command=r),u&&(s.status=u),null!==o&&(s.autodelete=o),i("put",["schedules",e],s)})},this.deleteSchedule=function(e){return p().then(function(){return i("delete",["schedules",e])})},this.getScenes=function(){return p().then(function(){return i("get",["scenes"])})},this.createScene=function(e,t,n){return p().then(function(){var r;return r={name:t,lights:n},i("put",["scenes",e],r)})},this.updateScene=function(e,t,n){return p().then(function(){return i("put",["scenes",e,"lights",t,"state"],n)})},this.getSensors=function(){return p().then(function(){return i("get",["sensors"])})},this.createSensor=function(e,t,n,r,s,u,o,a){return null==o&&(o=null),null==a&&(a=null),p().then(function(){var c;return c={name:e,modelid:t,swversion:n,type:r,uniqueid:s,manufacturername:u},o&&(c.state=o),a&&(c.config=a),i("post",["sensors"],c)})},this.searchNewSensors=function(){return p().then(function(){return i("post",["sensors"],null)})},this.getNewSensors=function(){return p().then(function(){return i("get",["sensors","new"])})},this.getSensor=function(e){return p().then(function(){return i("get",["sensors",e])})},this.renameSensor=function(e,t){return p().then(function(){var n;return n={name:t},i("put",["sensors",e],n)})},this.updateSensor=function(e,t){return p().then(function(){return i("put",["sensors",e,"config"],t)})},this.setSensorState=function(e,t){return p().then(function(){return i("put",["sensors",e,"state"],t)})},this.getTimezones=function(){return p().then(function(){return i("get",["info","timezones"])})},this.setEffect=function(e){return function(t,n){return null==n&&(n="none"),e.setLightState(t,{effect:n})}}(this),this.setAlert=function(e){return function(t,n){return null==n&&(n="none"),e.setLightState(t,{alert:n})}}(this),this.setBrightness=function(e){return function(t,n){return e.setLightState(t,{bri:n})}}(this)}]);